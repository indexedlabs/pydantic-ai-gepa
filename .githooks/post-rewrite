#!/bin/sh
set -eu

# post-rewrite is invoked by `git rebase` and `git commit --amend`.
# It passes old->new commit mappings on stdin. This updates commit evidence.
mt_cmd=""
if [ -x '/Users/mh/.cargo/bin/mt' ]; then
  mt_cmd='/Users/mh/.cargo/bin/mt'
elif command -v mt >/dev/null 2>&1; then
  mt_cmd="mt"
fi

if [ -n "$mt_cmd" ]; then
  "$mt_cmd" relink-commits --quiet 2>/dev/null || true
  if "$mt_cmd" rebuild --incremental >/dev/null 2>&1; then
    exit 0
  fi
fi

# Fallback: invalidate derived data; mt will rebuild on demand.
rm -f .mighty/cache.db .mighty/cache.db-wal .mighty/cache.db-shm
rm -rf .mighty/exports
